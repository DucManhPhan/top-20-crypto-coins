name: Validate CI/CD Pipeline

on:
  push:
    paths:
      - '.github/workflows/**'
  pull_request:
    paths:
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  validate:
    name: Pipeline Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Validate Workflow Syntax
      run: |
        echo "üîç Validating workflow files..."
        
        # Check if all workflow files exist
        WORKFLOWS=(
          ".github/workflows/deploy.yml"
          ".github/workflows/test.yml"
          ".github/workflows/code-quality.yml"
          ".github/workflows/terraform.yml"
          ".github/workflows/integration-test.yml"
        )
        
        for workflow in "${WORKFLOWS[@]}"; do
          if [ -f "$workflow" ]; then
            echo "‚úÖ $workflow exists"
          else
            echo "‚ùå $workflow missing"
            exit 1
          fi
        done

    - name: Check Workflow Dependencies
      run: |
        echo "üîó Checking workflow dependencies..."
        
        # Check if reusable workflows have workflow_call trigger
        if grep -q "workflow_call:" .github/workflows/test.yml; then
          echo "‚úÖ test.yml has workflow_call trigger"
        else
          echo "‚ùå test.yml missing workflow_call trigger"
          exit 1
        fi
        
        if grep -q "workflow_call:" .github/workflows/code-quality.yml; then
          echo "‚úÖ code-quality.yml has workflow_call trigger"
        else
          echo "‚ùå code-quality.yml missing workflow_call trigger"
          exit 1
        fi
        
        if grep -q "workflow_call:" .github/workflows/terraform.yml; then
          echo "‚úÖ terraform.yml has workflow_call trigger"
        else
          echo "‚ùå terraform.yml missing workflow_call trigger"
          exit 1
        fi

    - name: Validate Pipeline Logic
      run: |
        echo "üß† Validating pipeline logic..."
        
        # Check deploy.yml structure
        if grep -q "uses: ./.github/workflows/test.yml" .github/workflows/deploy.yml; then
          echo "‚úÖ deploy.yml calls test.yml"
        else
          echo "‚ùå deploy.yml doesn't call test.yml"
          exit 1
        fi
        
        if grep -q "needs: \[test, code-quality\]" .github/workflows/deploy.yml; then
          echo "‚úÖ terraform job depends on test and code-quality"
        else
          echo "‚ùå terraform job missing proper dependencies"
          exit 1
        fi
        
        echo "‚úÖ Pipeline validation completed successfully"